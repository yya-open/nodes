<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>åˆ†äº«çš„å¤‡å¿˜å½•</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Share page polish */
    .shareWrap{ max-width: 980px; margin: 18px auto; padding: 0 14px; }
    .hero{
      margin-top: 10px;
      padding: 18px 18px 14px;
      border-radius: 20px;
      border: 1px solid var(--line);
      background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
    }
    .heroTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap: 12px;
      flex-wrap: wrap;
    }
    .heroTitle{
      font-size: 28px; font-weight: 800; letter-spacing: .3px; margin: 0;
      line-height: 1.15;
    }
    .heroSub{
      margin-top: 8px;
      display:flex; gap: 8px; flex-wrap: wrap; align-items:center;
      color: var(--muted); font-size: 13px;
    }
    .badges{ display:flex; gap: 8px; flex-wrap: wrap; align-items:center; }
    .badgeStrong{
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: rgba(231,236,255,.9);
    }
    .badgeStrong.ok{
      background: rgba(91,124,250,.16);
      border-color: rgba(91,124,250,.30);
    }
    .badgeStrong.warn{
      background: rgba(255,92,122,.14);
      border-color: rgba(255,92,122,.32);
    }
    .badgeStrong.muted{ color: var(--muted); }
    .heroActions{ display:flex; gap: 10px; flex-wrap: wrap; }
    .noteCard{
      margin-top: 14px;
      border-radius: 20px;
      border:1px solid var(--line);
      background: rgba(18,26,51,.72);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .noteHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap: 12px;
      flex-wrap: wrap;
      padding-bottom: 10px;
      border-bottom: 1px dashed rgba(255,255,255,.10);
      margin-bottom: 12px;
    }
    .noteTitle{
      margin: 0;
      font-size: 20px;
      font-weight: 750;
      line-height: 1.25;
    }
    .noteMeta{
      margin-top: 6px;
      display:flex; flex-wrap: wrap; gap: 8px; align-items:center;
      color: var(--muted); font-size: 12px;
    }
    .noteBody{
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.65;
      font-size: 14px;
      color: rgba(231,236,255,.92);
    }
    .callout{
      margin-top: 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      padding: 10px 12px;
      color: rgba(231,236,255,.88);
      font-size: 13px;
      line-height: 1.5;
    }
    .callout.warn{
      background: rgba(255,92,122,.10);
      border-color: rgba(255,92,122,.28);
    }
    .grid2{
      display:grid;
      grid-template-columns: 1.4fr .6fr;
      gap: 14px;
      margin-top: 14px;
    }
    .sideCard{
      border-radius: 20px;
      border:1px solid var(--line);
      background: rgba(18,26,51,.62);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .sideTitle{ margin: 0 0 10px; font-size: 14px; color: rgba(231,236,255,.9); font-weight: 700; }
    .kv{ display:flex; justify-content:space-between; gap: 10px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,.06); font-size: 12px; color: var(--muted); }
    .kv:last-child{ border-bottom: none; }
    .kv b{ color: rgba(231,236,255,.88); font-weight: 650; }
    .footerHint{
      margin: 14px 2px 24px;
      color: rgba(231,236,255,.45);
      font-size: 12px;
      text-align:center;
    }
    .skeleton{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.08), rgba(255,255,255,.05));
      background-size: 200% 100%;
      animation: sk 1.2s ease-in-out infinite;
    }
    @keyframes sk { 0%{ background-position: 200% 0 } 100%{ background-position: -200% 0 } }
    .skLine{ height: 14px; margin: 10px 0; }
    .skLine.sm{ height: 10px; width: 60%; }
    .skBlock{ height: 120px; margin-top: 12px; }
    @media (max-width: 860px){
      .grid2{ grid-template-columns: 1fr; }
      .heroTitle{ font-size: 24px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">ğŸ—’ï¸</div>
      <div>
        <div class="title">åˆ†äº«çš„å¤‡å¿˜å½•</div>
        <div class="subtitle" id="subtitle">æ­£åœ¨åŠ è½½â€¦</div>
      </div>
    </div>
    <div class="actions">
      <span class="who" id="statusPill">åŠ è½½ä¸­</span>
    </div>
  </div>

  <div class="shareWrap">
    <div class="hero" id="hero">
      <div class="heroTop">
        <div>
          <h1 class="heroTitle" id="pageTitle">åˆ†äº«çš„å¤‡å¿˜å½•</h1>
          <div class="heroSub">
            <span class="badgeStrong muted" id="linkType">â€”</span>
            <span class="badgeStrong muted" id="expBadge">â€”</span>
            <span class="badgeStrong muted" id="readsBadge">â€”</span>
          </div>
        </div>

        <div class="heroActions">
          <button class="btn primary" id="btnCopy">å¤åˆ¶å†…å®¹</button>
          <button class="btn" id="btnCopyAll">å¤åˆ¶æ ‡é¢˜+å†…å®¹</button>
          <button class="btn" id="btnDownload">ä¸‹è½½ TXT</button>
        </div>
      </div>

      <div class="callout warn hidden" id="burnCallout">
        âš ï¸ è¿™æ˜¯ã€Œé˜…åå³ç„šã€åˆ†äº«é“¾æ¥ï¼šæœ¬æ¬¡æ‰“å¼€åé“¾æ¥å°†å¤±æ•ˆï¼ˆå†æ¬¡è®¿é—®å¯èƒ½æ˜¾ç¤ºå·²å¤±æ•ˆ/å·²è¿‡æœŸï¼‰ã€‚
      </div>
      <div class="callout hidden" id="expCallout"></div>
    </div>

    <div class="grid2">
      <div class="noteCard" id="noteCard">
        <div class="noteHead">
          <div>
            <h2 class="noteTitle" id="noteTitle">ï¼ˆåŠ è½½ä¸­ï¼‰</h2>
            <div class="noteMeta" id="noteMeta">
              <span class="badge">â€”</span>
            </div>
          </div>
        </div>

        <p class="noteBody" id="noteBody"></p>

        <div class="callout hidden" id="errorBox"></div>

        <div class="skeleton" id="skeleton" style="padding:14px;">
          <div class="skeleton skLine"></div>
          <div class="skeleton skLine sm"></div>
          <div class="skeleton skBlock"></div>
        </div>
      </div>

      <div class="sideCard">
        <p class="sideTitle">ä¿¡æ¯</p>
        <div class="kv"><span>åˆ†äº«ç </span><b id="kvCode">â€”</b></div>
        <div class="kv"><span>æ‰“å¼€æ—¶é—´</span><b id="kvServedAt">â€”</b></div>
        <div class="kv"><span>è¿‡æœŸæ—¶é—´</span><b id="kvExpiresAt">â€”</b></div>
        <div class="kv"><span>æ‰“å¼€æ¬¡æ•°</span><b id="kvReads">â€”</b></div>
      </div>
    </div>

    <div class="footerHint">æç¤ºï¼šåˆ†äº«é¡µä»…å±•ç¤ºå†…å®¹ï¼Œä¸åŒ…å«ä½ çš„è´¦å·ä¿¡æ¯ã€‚</div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function fmt(dt) {
    if (!dt) return "â€”";
    const t = Date.parse(String(dt));
    if (Number.isNaN(t)) return String(dt);
    const d = new Date(t);
    const pad = (n) => String(n).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function relExpire(expiresAt) {
    if (!expiresAt) return { text: "ä¸è¿‡æœŸ", warn: false };
    const t = Date.parse(String(expiresAt));
    if (Number.isNaN(t)) return { text: fmt(expiresAt), warn: false };
    const diff = t - Date.now();
    if (diff <= 0) return { text: "å·²è¿‡æœŸ", warn: true };
    const mins = Math.floor(diff / 60000);
    if (mins < 60) return { text: `${mins} åˆ†é’Ÿåè¿‡æœŸ`, warn: true };
    const hours = Math.floor(mins / 60);
    if (hours < 24) return { text: `${hours} å°æ—¶åè¿‡æœŸ`, warn: hours <= 6 };
    const days = Math.floor(hours / 24);
    return { text: `${days} å¤©åè¿‡æœŸ`, warn: days <= 1 };
  }

  function getCode() {
    const qs = new URLSearchParams(location.search);
    const token = qs.get("token");
    const hashCode = (location.hash || "").replace(/^#/, "");
    return token || hashCode || "";
  }

  async function copyText(text) {
    await navigator.clipboard.writeText(text);
    $("statusPill").textContent = "å·²å¤åˆ¶";
    setTimeout(() => $("statusPill").textContent = "å·²åŠ è½½", 1200);
  }

  function downloadText(filename, text) {
    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  (async () => {
    const code = getCode();
    $("kvCode").textContent = code || "â€”";

    if (!code) {
      $("subtitle").textContent = "ç¼ºå°‘ token/code";
      $("statusPill").textContent = "é”™è¯¯";
      $("errorBox").classList.remove("hidden");
      $("errorBox").classList.add("warn");
      $("errorBox").textContent = "é“¾æ¥ä¸å®Œæ•´ï¼šè¯·ä½¿ç”¨åˆ†äº«é“¾æ¥æ‰“å¼€ï¼ˆhash æˆ– ?token=ï¼‰ã€‚";
      $("skeleton").classList.add("hidden");
      return;
    }

    try {
      $("subtitle").textContent = "æ­£åœ¨è·å–å†…å®¹â€¦";
      $("statusPill").textContent = "åŠ è½½ä¸­";

      const res = await fetch("/api/share/" + encodeURIComponent(code), { credentials: "include" });
      const ct = res.headers.get("content-type") || "";
      const data = ct.includes("application/json") ? await res.json() : { error: await res.text() };
      if (!res.ok) throw new Error(data.error || ("HTTP " + res.status));

      const note = data.note || {};
      const meta = data.meta || {};

      document.title = (note.title ? note.title + " Â· " : "") + "åˆ†äº«çš„å¤‡å¿˜å½•";
      $("pageTitle").textContent = "åˆ†äº«çš„å¤‡å¿˜å½•";
      $("subtitle").textContent = "å·²åŠ è½½";
      $("statusPill").textContent = "å·²åŠ è½½";

      // Badges
      const burned = !!meta.burned;
      $("linkType").textContent = burned ? "é˜…åå³ç„šé“¾æ¥" : "æ™®é€šåˆ†äº«é“¾æ¥";
      $("linkType").className = "badgeStrong " + (burned ? "warn" : "ok");

      const exp = relExpire(meta.expiresAt);
      $("expBadge").textContent = exp.text;
      $("expBadge").className = "badgeStrong " + (exp.warn ? "warn" : "muted");

      $("readsBadge").textContent = `å·²æ‰“å¼€ ${Number(meta.reads || 0)} æ¬¡`;
      $("readsBadge").className = "badgeStrong muted";

      // Callouts
      if (burned) $("burnCallout").classList.remove("hidden");
      if (meta.expiresAt) {
        $("expCallout").classList.remove("hidden");
        $("expCallout").textContent = `â³ è¿‡æœŸæ—¶é—´ï¼š${fmt(meta.expiresAt)}ï¼ˆ${exp.text}ï¼‰`;
      }

      // Note content
      $("noteTitle").textContent = note.title || "ï¼ˆæ— æ ‡é¢˜ï¼‰";
      const tags = Array.isArray(note.tags) ? note.tags : [];
      const tagHtml = tags.length
        ? `<span class="badge">æ ‡ç­¾</span><span class="tags">${tags.map(t => `<span class="tag">${String(t)}</span>`).join("")}</span>`
        : `<span class="badge">æ— æ ‡ç­¾</span>`;
      $("noteMeta").innerHTML = `
        <span class="badge">åˆ›å»ºï¼š${fmt(note.createdAt)}</span>
        <span class="badge">æ›´æ–°ï¼š${fmt(note.updatedAt)}</span>
        ${tagHtml}
      `;

      $("noteBody").textContent = note.body || "";
      $("skeleton").classList.add("hidden");

      // Side info
      $("kvServedAt").textContent = fmt(meta.servedAt);
      $("kvExpiresAt").textContent = meta.expiresAt ? fmt(meta.expiresAt) : "ä¸è¿‡æœŸ";
      $("kvReads").textContent = String(meta.reads ?? "â€”");

      // Actions
      $("btnCopy").onclick = async () => copyText(note.body || "");
      $("btnCopyAll").onclick = async () => copyText(`${note.title || ""}\n\n${note.body || ""}`.trim());
      $("btnDownload").onclick = () => downloadText((note.title || "note") + ".txt", note.body || "");

    } catch (e) {
      $("subtitle").textContent = "åŠ è½½å¤±è´¥";
      $("statusPill").textContent = "å¤±è´¥";
      $("skeleton").classList.add("hidden");
      $("errorBox").classList.remove("hidden");
      $("errorBox").classList.add("warn");
      $("errorBox").textContent = "åŠ è½½å¤±è´¥ï¼š" + (e.message || e);
      $("linkType").textContent = "æ— æ³•åŠ è½½";
      $("linkType").className = "badgeStrong warn";
      $("expBadge").textContent = "â€”";
      $("readsBadge").textContent = "â€”";
    }
  })();
</script>
</body>
</html>
